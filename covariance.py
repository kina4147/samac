import numpy as np


class Covariance(object):
  '''
  Define different Kalman Filter covariance matrix
  Kalman Filter states:
  [x, y, z, rot_y, l, w, h, x_dot, y_dot, z_dot]
  '''
  def __init__(self, covariance_id):
    NUSCENES_TRACKING_NAMES = [
      'bicycle',
      'bus',
      'car',
      'motorcycle',
      'pedestrian',
      'trailer',
      'truck'
    ]
    if covariance_id == 1:
        # nuscenes # x, y, theta, v, theta'
        m_head_P = {
        'bicycle': [0.05390982, 0.05039431, 1.29464435, 0.06130649, 1.21635902],
        'bus': [0.17546469, 0.13818929, 0.1979503, 0.175599858, 0.22529652],
        'car': [0.08900372, 0.09412005, 1.00535696, 0.115581232, 0.99492726],
        'motorcycle': [0.04052819, 0.0398904, 1.06442726, 0.061505764, 1.30414345],
        'pedestrian': [0.03855275, 0.0377111, 2.0751833, 0.058906636, 2.0059979],
        'trailer': [0.23228021, 0.22229261, 1.05163481, 0.290263582, 0.97082174],
        'truck': [0.14862173, 0.1444596, 0.73122169, 0.148047001, 0.76188901]
        }

        m_head_Q = {
        'bicycle': [1.98881347e-02, 1.36552276e-02, 1.33430252e-01, 0.024124741, 1.33430252e-01],
        'bus': [1.17729925e-01, 8.84659079e-02, 2.09050032e-01, 0.147263546, 2.09050032e-01],
        'car': [1.58918523e-01, 1.24935318e-01, 9.22800791e-02, 0.202148289, 9.22800791e-02],
        'motorcycle': [3.23647590e-02, 3.86650974e-02, 2.34967407e-01, 0.050422885, 2.34967407e-01],
        'pedestrian': [3.34814566e-02, 2.47354921e-02, 4.24962535e-01, 0.041627545, 4.24962535e-01],
        'trailer': [4.19985099e-02, 3.68661552e-02, 5.63166240e-02, 0.055883703, 5.63166240e-02],
        'truck': [9.45275998e-02, 9.45620374e-02, 1.41680460e-01, 0.133706567, 1.41680460e-01]
        }

        m_R = {
        'bicycle': [0.05390982, 0.05039431, 1.29464435],
        'bus': [0.17546469, 0.13818929, 0.1979503],
        'car': [0.08900372, 0.09412005, 1.00535696],
        'motorcycle': [0.04052819, 0.0398904, 1.06442726],
        'pedestrian': [0.03855275, 0.0377111, 2.0751833],
        'trailer': [0.23228021, 0.22229261, 1.05163481],
        'truck': [0.14862173, 0.1444596, 0.73122169]
        }

        #Kalman Filter state: [x, y, yaw, x', y', yaw']
        m_no_head_P = {
        'bicycle': [0.05390982, 0.05039431, 1.29464435, 0.04560422, 0.04097244, 1.21635902],
        'bus': [0.17546469, 0.13818929, 0.1979503, 0.13263319, 0.11508148, 0.22529652],
        'car': [0.08900372, 0.09412005, 1.00535696, 0.08120681, 0.08224643, 0.99492726],
        'motorcycle': [0.04052819, 0.0398904, 1.06442726, 0.0437039, 0.04327734, 1.30414345],
        'pedestrian': [0.03855275, 0.0377111, 2.0751833, 0.04237008, 0.04092393, 2.0059979],
        'trailer': [0.23228021, 0.22229261, 1.05163481, 0.2138643, 0.19625241, 0.97082174],
        'truck': [0.14862173, 0.1444596, 0.73122169, 0.10683797, 0.10248689, 0.76188901]
        }

        m_no_head_Q = {
        'bicycle': [1.98881347e-02, 1.36552276e-02, 1.33430252e-01, 1.98881347e-02, 1.36552276e-02, 1.33430252e-01],
        'bus': [1.17729925e-01, 8.84659079e-02, 2.09050032e-01, 1.17729925e-01, 8.84659079e-02, 2.09050032e-01],
        'car': [1.58918523e-01, 1.24935318e-01, 9.22800791e-02, 1.58918523e-01, 1.24935318e-01, 9.22800791e-02],
        'motorcycle': [3.23647590e-02, 3.86650974e-02, 2.34967407e-01, 3.23647590e-02, 3.86650974e-02, 2.34967407e-01],
        'pedestrian': [3.34814566e-02, 2.47354921e-02, 4.24962535e-01, 3.34814566e-02, 2.47354921e-02, 4.24962535e-01],
        'trailer': [4.19985099e-02, 3.68661552e-02, 5.63166240e-02, 4.19985099e-02, 3.68661552e-02, 5.63166240e-02],
        'truck': [9.45275998e-02, 9.45620374e-02, 1.41680460e-01, 9.45275998e-02, 9.45620374e-02, 1.41680460e-01]
        }

        a_P = {
        'bicycle': [0.01863044, 0.01169572, 0.02713823, 0.01295084, 0.01725477],
        'bus': [0.05947248, 0.05507407, 0.78867322, 0.06684149, 0.05033665],
        'car': [0.03265469, 0.02359175, 0.10912802, 0.02455134, 0.02266425],
        'motorcycle': [0.01511711, 0.00957574, 0.03291016, 0.0111605, 0.01465631],
        'pedestrian': [0.02482115, 0.0136347, 0.02286483, 0.0203149, 0.01482923],
        'trailer': [0.07006275, 0.06354783, 1.37451601, 0.10500918, 0.05231335],
        'truck': [0.05417157, 0.05484365, 0.69387238, 0.07748085, 0.0378078]
        }

        a_Q = {
        'bicycle': [5.10175742e-03, 0, 0, 0, 5.10175742e-03],
        'bus': [1.17616440e-02, 0, 0, 0, 1.17616440e-02],
        'car': [5.35573165e-03, 0, 0, 0, 5.35573165e-03],
        'motorcycle': [5.47421635e-03, 0, 0, 0, 5.47421635e-03],
        'pedestrian': [5.94592529e-03, 0, 0, 0, 5.94592529e-03],
        'trailer': [1.19415050e-02, 0, 0, 0, 1.19415050e-02],
        'truck': [8.38061721e-03, 0, 0, 0, 8.38061721e-03]
        }

        a_R = {
        'bicycle': [0.01863044, 0.01169572, 0.02713823, 0.01295084],
        'bus': [0.05947248, 0.05507407, 0.78867322, 0.06684149],
        'car': [0.03265469, 0.02359175, 0.10912802, 0.02455134],
        'motorcycle': [0.01511711, 0.00957574, 0.03291016, 0.0111605],
        'pedestrian': [0.02482115, 0.0136347, 0.02286483, 0.0203149],
        'trailer': [0.07006275, 0.06354783, 1.37451601, 0.10500918],
        'truck': [0.05417157, 0.05484365, 0.69387238, 0.07748085]
        }
        self.AP = {
        'bicycle': 0.223,
        'bus': 0.549,
        'car': 0.811,
        'motorcycle': 0.515,
        'pedestrian': 0.801,
        'trailer': 0.429,
        'truck': 0.485

        }
        self.m_head_P = {tracking_name: np.diag(m_head_P[tracking_name]) for tracking_name in NUSCENES_TRACKING_NAMES}
        self.m_head_Q = {tracking_name: np.diag(m_head_Q[tracking_name]) for tracking_name in NUSCENES_TRACKING_NAMES}
        self.m_no_head_P = {tracking_name: np.diag(m_no_head_P[tracking_name]) for tracking_name in NUSCENES_TRACKING_NAMES}
        self.m_no_head_Q = {tracking_name: np.diag(m_no_head_Q[tracking_name]) for tracking_name in NUSCENES_TRACKING_NAMES}
        self.m_R = {tracking_name: np.diag(m_R[tracking_name]) for tracking_name in NUSCENES_TRACKING_NAMES}
        self.a_P = {tracking_name: np.diag(a_P[tracking_name]) for tracking_name in NUSCENES_TRACKING_NAMES}
        self.a_Q = {tracking_name: np.diag(a_Q[tracking_name]) for tracking_name in NUSCENES_TRACKING_NAMES}
        self.a_R = {tracking_name: np.diag(a_R[tracking_name]) for tracking_name in NUSCENES_TRACKING_NAMES}
        self.mdist_threshold ={}
        # 95%
        # self.mdist_threshold[2] = 5.991
        # self.mdist_threshold[3] = 7.815
        # self.mdist_threshold[4] = 9.448
        # self.mdist_threshold[5] = 11.071
        # self.mdist_threshold[6] = 12.592
        # self.mdist_threshold[7] = 14.067
        # 90%
        self.mdist_threshold[2] = 4.605# 4.1 #
        self.mdist_threshold[3] = 6.251# 5.6 #
        self.mdist_threshold[4] = 7.14 # 7.779# 7.0 #
        self.mdist_threshold[5] = 9.2361# 8.4 #
        self.mdist_threshold[6] = 10.645# 9.7 #
        self.mdist_threshold[7] = 11.0 # 12.017# 11.0 #
    elif covariance_id == 2:
        m_head_P = {'bicycle': [0.053909816622672024, 0.05039430776336743, 0.6893872077951395, 0.06343709836527914,
                                0.7505281764663858],
                    'bus': [0.17546468614970184, 0.13818929310324551, 0.05704350212516808, 0.18648497688355806,
                            0.06164272878258143],
                    'car': [0.08900372401044265, 0.094120047588759, 0.6713035126560539, 0.1191323527000443,
                            0.664865179802279],
                    'motorcycle': [0.04052818815248084, 0.03989039706937437, 0.2892766787113707, 0.06405069691027308,
                                   0.3650899410060215],
                    'pedestrian': [0.03855275093021614, 0.03771109830309922, 0.7770012239322505, 0.05254060515629411,
                                   0.7923390659524018],
                    'trailer': [0.23228020828365079, 0.22229261453203458, 0.8646508102103945, 0.23926164738387815,
                                0.770063438522177],
                    'truck': [0.148621732813482, 0.14445959531988212, 0.36903791417462267, 0.1490140169876236,
                              0.390442783803114]}
        m_head_Q = {'bicycle': [0.017575825483969406, 0.012514663441570094, 0.00812268558710475, 0.02023260074945089,
                                0.00812268558710475],
                    'bus': [0.1060745935038525, 0.08525198236999318, 0.0002753768773973421, 0.13672041450078196,
                            0.0002753768773973421],
                    'car': [0.14075415349092074, 0.11236393462203138, 0.0005147269684294603, 0.15628745771528604,
                            0.0005147269684294603],
                    'motorcycle': [0.032433060737185194, 0.03883446723748835, 0.0010462697413800384,
                                   0.04711464593020689, 0.0010462697413800384],
                    'pedestrian': [0.033215941639606845, 0.02460987708542488, 0.009808133067738352,
                                   0.036325334100330495, 0.009808133067738352],
                    'trailer': [0.03810932101101336, 0.03248587222126512, 0.0018563427327931412, 0.04656570811784972,
                                0.0018563427327931412],
                    'truck': [0.08556833350513886, 0.08649377480925055, 0.0002677540893609599, 0.09065700335613543,
                              0.0002677540893609599]}
        m_no_head_P = {'bicycle': [0.053909816622672024, 0.05039430776336743, 0.6893872077951395, 0.04097243520778485,
                                   0.0172547653553789, 0.7505281764663858],
                       'bus': [0.17546468614970184, 0.13818929310324551, 0.05704350212516808, 0.11508148399339621,
                               0.050336645422805554, 0.06164272878258143],
                       'car': [0.08900372401044265, 0.094120047588759, 0.6713035126560539, 0.08224643328556765,
                               0.02266425268224573, 0.664865179802279],
                       'motorcycle': [0.04052818815248084, 0.03989039706937437, 0.2892766787113707, 0.04327734028674202,
                                      0.0146563131395411, 0.3650899410060215],
                       'pedestrian': [0.03855275093021614, 0.03771109830309922, 0.7770012239322505, 0.04092393194638888,
                                      0.014829229871699481, 0.7923390659524018],
                       'trailer': [0.23228020828365079, 0.22229261453203458, 0.8646508102103945, 0.19625240922792728,
                                   0.05231335245078203, 0.770063438522177],
                       'truck': [0.148621732813482, 0.14445959531988212, 0.36903791417462267, 0.10248688605166786,
                                 0.03780780233299205, 0.390442783803114]}
        m_no_head_Q = {
            'bicycle': [0.017575825483969406, 0.012514663441570094, 0.00812268558710475, 0.017575825483969406,
                        0.012514663441570094, 0.00812268558710475],
            'bus': [0.1060745935038525, 0.08525198236999318, 0.0002753768773973421, 0.1060745935038525,
                    0.08525198236999318, 0.0002753768773973421],
            'car': [0.14075415349092074, 0.11236393462203138, 0.0005147269684294603, 0.14075415349092074,
                    0.11236393462203138, 0.0005147269684294603],
            'motorcycle': [0.032433060737185194, 0.03883446723748835, 0.0010462697413800384, 0.032433060737185194,
                           0.03883446723748835, 0.0010462697413800384],
            'pedestrian': [0.033215941639606845, 0.02460987708542488, 0.009808133067738352, 0.033215941639606845,
                           0.02460987708542488, 0.009808133067738352],
            'trailer': [0.03810932101101336, 0.03248587222126512, 0.0018563427327931412, 0.03810932101101336,
                        0.03248587222126512, 0.0018563427327931412],
            'truck': [0.08556833350513886, 0.08649377480925055, 0.0002677540893609599, 0.08556833350513886,
                      0.08649377480925055, 0.0002677540893609599]}
        m_R = {'bicycle': [0.053909816622672024, 0.05039430776336743, 0.6893872077951395],
               'bus': [0.17546468614970184, 0.13818929310324551, 0.05704350212516808],
               'car': [0.08900372401044265, 0.094120047588759, 0.6713035126560539],
               'motorcycle': [0.04052818815248084, 0.03989039706937437, 0.2892766787113707],
               'pedestrian': [0.03855275093021614, 0.03771109830309922, 0.7770012239322505],
               'trailer': [0.23228020828365079, 0.22229261453203458, 0.8646508102103945],
               'truck': [0.148621732813482, 0.14445959531988212, 0.36903791417462267]}
        a_P = {'bicycle': [0.01863043793121039, 0.011695722227478769, 0.02713822810488674, 0.012950839670988598,
                           0.0172547653553789],
               'bus': [0.059472484368828606, 0.05507406879114136, 0.7886732192718318, 0.06684148527301625,
                       0.050336645422805554],
               'car': [0.032654692110074525, 0.023591753546672447, 0.10912801947857925, 0.02455133621224933,
                       0.02266425268224573],
               'motorcycle': [0.015117108733474504, 0.00957573702428942, 0.03291015700672654, 0.011160495564352762,
                              0.0146563131395411],
               'pedestrian': [0.02482115053475284, 0.013634696413790663, 0.022864831313812242, 0.020314902707302435,
                              0.014829229871699481],
               'trailer': [0.07006274598719352, 0.06354783250019519, 1.3745160058752897, 0.1050091843880693,
                           0.05231335245078203],
               'truck': [0.05417156547240919, 0.05484365373515145, 0.6938723780299684, 0.07748084797180696,
                         0.03780780233299205]}
        a_Q = {'bicycle': [0.004614341147122543, 0.0, 0.0, 0.0, 0.004614341147122543],
               'bus': [0.010634614494109499, 0.0, 0.0, 0.0, 0.010634614494109499],
               'car': [0.004833526136231382, 0.0, 0.0, 0.0, 0.004833526136231382],
               'motorcycle': [0.0049529245571433966, 0.0, 0.0, 0.0, 0.0049529245571433966],
               'pedestrian': [0.005567827010294878, 0.0, 0.0, 0.0, 0.005567827010294878],
               'trailer': [0.009796590137551096, 0.0, 0.0, 0.0, 0.009796590137551096],
               'truck': [0.007721672660546974, 0.0, 0.0, 0.0, 0.007721672660546974]}
        a_R = {'bicycle': [0.01863043793121039, 0.011695722227478769, 0.02713822810488674, 0.012950839670988598],
               'bus': [0.059472484368828606, 0.05507406879114136, 0.7886732192718318, 0.06684148527301625],
               'car': [0.032654692110074525, 0.023591753546672447, 0.10912801947857925, 0.02455133621224933],
               'motorcycle': [0.015117108733474504, 0.00957573702428942, 0.03291015700672654, 0.011160495564352762],
               'pedestrian': [0.02482115053475284, 0.013634696413790663, 0.022864831313812242, 0.020314902707302435],
               'trailer': [0.07006274598719352, 0.06354783250019519, 1.3745160058752897, 0.1050091843880693],
               'truck': [0.05417156547240919, 0.05484365373515145, 0.6938723780299684, 0.07748084797180696]}

        self.m_head_P = {tracking_name: np.diag(m_head_P[tracking_name]) for tracking_name in NUSCENES_TRACKING_NAMES}
        self.m_head_Q = {tracking_name: np.diag(m_head_Q[tracking_name]) for tracking_name in NUSCENES_TRACKING_NAMES}
        self.m_no_head_P = {tracking_name: np.diag(m_no_head_P[tracking_name]) for tracking_name in
                          NUSCENES_TRACKING_NAMES}
        self.m_no_head_Q = {tracking_name: np.diag(m_no_head_Q[tracking_name]) for tracking_name in
                          NUSCENES_TRACKING_NAMES}
        self.m_R = {tracking_name: np.diag(m_R[tracking_name]) for tracking_name in NUSCENES_TRACKING_NAMES}
        self.a_P = {tracking_name: np.diag(a_P[tracking_name]) for tracking_name in NUSCENES_TRACKING_NAMES}
        self.a_Q = {tracking_name: np.diag(a_Q[tracking_name]) for tracking_name in NUSCENES_TRACKING_NAMES}
        self.a_R = {tracking_name: np.diag(a_R[tracking_name]) for tracking_name in NUSCENES_TRACKING_NAMES}
        self.mdist_threshold = {}
        # 95%
        # self.mdist_threshold[2] = 5.991
        # self.mdist_threshold[3] = 7.815
        # self.mdist_threshold[4] = 9.448
        # self.mdist_threshold[5] = 11.071
        # self.mdist_threshold[6] = 12.592
        # self.mdist_threshold[7] = 14.067
        # 90%
        self.mdist_threshold[2] = 4.605
        self.mdist_threshold[3] = 6.251
        self.mdist_threshold[4] = 7.779
        self.mdist_threshold[5] = 9.2361
        self.mdist_threshold[6] = 10.645
        self.mdist_threshold[7] = 12.017
    else:
      assert(False)
